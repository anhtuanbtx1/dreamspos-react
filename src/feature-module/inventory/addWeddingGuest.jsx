import React, { useState } from 'react';
import { Form, Input, InputNumber, Select, Button, Card, message, Row, Col } from 'antd';
import { useNavigate, Link } from 'react-router-dom';
import { ArrowLeft, Save, Heart } from 'react-feather';
import { weddingGuestService } from '../../services/weddingGuestService';

const { Option } = Select;
const { TextArea } = Input;

const AddWeddingGuest = () => {
  const navigate = useNavigate();
  const [form] = Form.useForm();
  const [submitting, setSubmitting] = useState(false);

  // Handle form submission
  const handleSubmit = async (values) => {
    setSubmitting(true);
    try {
      console.log('üì§ Creating guest with values:', values);

      // Prepare create data according to API model (kh√¥ng g·ª≠i id, createdDate, createdBy)
      const createData = {
        name: values.name,
        unit: values.unit,
        numberOfPeople: values.numberOfPeople,
        giftAmount: values.giftAmount,
        status: values.status,
        relationship: values.relationship,
        notes: values.notes || '',
        updatedDate: new Date().toISOString(),
        updatedBy: 'current-user', // You might want to get this from auth context
        isActive: true
      };

      console.log('üì§ Final create data:', createData);

      const response = await weddingGuestService.createWeddingGuest(createData);

      if (response.success) {
        message.success('Th√™m kh√°ch m·ªùi th√†nh c√¥ng!');
        navigate('/wedding-guest-list');
      } else {
        message.error(response.message || 'Failed to create guest');
      }
    } catch (error) {
      console.error('Error creating guest:', error);
      message.error('An error occurred while creating guest');
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <div className="page-wrapper">
      <style>
        {`
          /* Force light theme styles for all form elements */
          .page-wrapper .content .ant-form-item-label > label,
          .page-wrapper .content .ant-form-item label {
            color: #000000 !important;
          }

          .page-wrapper .content .ant-input,
          .page-wrapper .content .ant-input-number,
          .page-wrapper .content .ant-input-number-input,
          .page-wrapper .content .ant-select-selection-item,
          .page-wrapper .content .ant-select-selector,
          .page-wrapper .content .ant-select-single .ant-select-selector,
          .page-wrapper .content textarea.ant-input {
            color: #000000 !important;
            background-color: #ffffff !important;
            border-color: #d9d9d9 !important;
          }

          .page-wrapper .content .ant-input:focus,
          .page-wrapper .content .ant-input-number:focus,
          .page-wrapper .content .ant-input-number-input:focus,
          .page-wrapper .content .ant-select-focused .ant-select-selector,
          .page-wrapper .content textarea.ant-input:focus {
            color: #000000 !important;
            background-color: #ffffff !important;
            border-color: #40a9ff !important;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2) !important;
          }

          .page-wrapper .content .ant-input::placeholder,
          .page-wrapper .content .ant-input-number-input::placeholder,
          .page-wrapper .content textarea.ant-input::placeholder {
            color: #999999 !important;
          }

          .page-wrapper .content .ant-card {
            background-color: #ffffff !important;
            border-color: #d9d9d9 !important;
          }

          /* Dark theme overrides */
          [data-theme="dark"] .page-wrapper .content .ant-form-item-label > label,
          [data-theme="dark"] .page-wrapper .content .ant-form-item label {
            color: #ffffff !important;
          }

          [data-theme="dark"] .page-wrapper .content .ant-input,
          [data-theme="dark"] .page-wrapper .content .ant-input-number,
          [data-theme="dark"] .page-wrapper .content .ant-input-number-input,
          [data-theme="dark"] .page-wrapper .content .ant-select-selection-item,
          [data-theme="dark"] .page-wrapper .content .ant-select-selector,
          [data-theme="dark"] .page-wrapper .content .ant-select-single .ant-select-selector,
          [data-theme="dark"] .page-wrapper .content textarea.ant-input {
            color: #ffffff !important;
            background-color: #1f1f1f !important;
            border-color: #434343 !important;
          }

          [data-theme="dark"] .page-wrapper .content .ant-input:focus,
          [data-theme="dark"] .page-wrapper .content .ant-input-number:focus,
          [data-theme="dark"] .page-wrapper .content .ant-input-number-input:focus,
          [data-theme="dark"] .page-wrapper .content .ant-select-focused .ant-select-selector,
          [data-theme="dark"] .page-wrapper .content textarea.ant-input:focus {
            color: #ffffff !important;
            background-color: #1f1f1f !important;
            border-color: #177ddc !important;
            box-shadow: 0 0 0 2px rgba(23, 125, 220, 0.2) !important;
          }

          [data-theme="dark"] .page-wrapper .content .ant-input::placeholder,
          [data-theme="dark"] .page-wrapper .content .ant-input-number-input::placeholder,
          [data-theme="dark"] .page-wrapper .content textarea.ant-input::placeholder {
            color: #888888 !important;
          }

          [data-theme="dark"] .page-wrapper .content .ant-card {
            background-color: #1f1f1f !important;
            border-color: #434343 !important;
          }

          [data-theme="dark"] .page-wrapper .content .ant-select-dropdown {
            background-color: #1f1f1f !important;
            border-color: #434343 !important;
          }

          [data-theme="dark"] .page-wrapper .content .ant-select-item {
            color: #ffffff !important;
            background-color: #1f1f1f !important;
          }

          [data-theme="dark"] .page-wrapper .content .ant-select-item:hover {
            background-color: #434343 !important;
            color: #ffffff !important;
          }

          [data-theme="dark"] .page-wrapper .content .ant-select-item-option-selected {
            background-color: #177ddc !important;
            color: #ffffff !important;
          }

          /* System dark theme detection */
          @media (prefers-color-scheme: dark) {
            body:not([data-theme="light"]) .page-wrapper .content .ant-form-item-label > label,
            body:not([data-theme="light"]) .page-wrapper .content .ant-form-item label {
              color: #ffffff !important;
            }

            body:not([data-theme="light"]) .page-wrapper .content .ant-input,
            body:not([data-theme="light"]) .page-wrapper .content .ant-input-number,
            body:not([data-theme="light"]) .page-wrapper .content .ant-input-number-input,
            body:not([data-theme="light"]) .page-wrapper .content .ant-select-selection-item,
            body:not([data-theme="light"]) .page-wrapper .content .ant-select-selector,
            body:not([data-theme="light"]) .page-wrapper .content .ant-select-single .ant-select-selector,
            body:not([data-theme="light"]) .page-wrapper .content textarea.ant-input {
              color: #ffffff !important;
              background-color: #1f1f1f !important;
              border-color: #434343 !important;
            }

            body:not([data-theme="light"]) .page-wrapper .content .ant-input::placeholder,
            body:not([data-theme="light"]) .page-wrapper .content .ant-input-number-input::placeholder,
            body:not([data-theme="light"]) .page-wrapper .content textarea.ant-input::placeholder {
              color: #888888 !important;
            }

            body:not([data-theme="light"]) .page-wrapper .content .ant-card {
              background-color: #1f1f1f !important;
              border-color: #434343 !important;
            }
          }
        `}
      </style>
      <div className="content">
        {/* Header */}
        <div className="page-header">
          <div className="add-item d-flex">
            <div className="page-title">
              <h4>
                <Heart size={20} style={{ marginRight: '8px', color: '#ff69b4' }} />
                Th√™m kh√°ch m·ªùi ƒë√°m c∆∞·ªõi
              </h4>
              <h6>Th√™m kh√°ch m·ªùi m·ªõi v√†o danh s√°ch</h6>
            </div>
          </div>
          <div className="page-btn">
            <Link to="/wedding-guest-list">
              <Button
                type="default"
                icon={<ArrowLeft size={16} />}
              >
                Quay l·∫°i
              </Button>
            </Link>
          </div>
        </div>

        {/* Form */}
        <Card>
          <Form
            form={form}
            layout="vertical"
            onFinish={handleSubmit}
            autoComplete="off"
            initialValues={{
              numberOfPeople: 1,
              giftAmount: 0,
              status: 'Pending'
            }}
          >
            <Row gutter={24}>
              <Col xs={24} sm={12}>
                <Form.Item
                  label="T√™n kh√°ch m·ªùi"
                  name="name"
                  rules={[
                    { required: true, message: 'Vui l√≤ng nh·∫≠p t√™n kh√°ch m·ªùi!' },
                    { min: 2, message: 'T√™n ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±!' }
                  ]}
                >
                  <Input placeholder="Nh·∫≠p t√™n kh√°ch m·ªùi" />
                </Form.Item>
              </Col>

              <Col xs={24} sm={12}>
                <Form.Item
                  label="ƒê∆°n v·ªã"
                  name="unit"
                  rules={[{ required: true, message: 'Vui l√≤ng nh·∫≠p ƒë∆°n v·ªã!' }]}
                >
                  <Input placeholder="Nh·∫≠p ƒë∆°n v·ªã" />
                </Form.Item>
              </Col>
            </Row>

            <Row gutter={24}>
              <Col xs={24} sm={8}>
                <Form.Item
                  label="S·ªë ng∆∞·ªùi"
                  name="numberOfPeople"
                  rules={[
                    { required: true, message: 'Vui l√≤ng nh·∫≠p s·ªë ng∆∞·ªùi!' },
                    { type: 'number', min: 1, message: 'S·ªë ng∆∞·ªùi ph·∫£i l·ªõn h∆°n 0!' }
                  ]}
                >
                  <InputNumber
                    placeholder="Nh·∫≠p s·ªë ng∆∞·ªùi"
                    style={{ width: '100%' }}
                    min={1}
                  />
                </Form.Item>
              </Col>

              <Col xs={24} sm={8}>
                <Form.Item
                  label="S·ªë ti·ªÅn m·ª´ng (VND)"
                  name="giftAmount"
                  rules={[
                    { required: true, message: 'Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn m·ª´ng!' },
                    { type: 'number', min: 0, message: 'S·ªë ti·ªÅn ph·∫£i l·ªõn h∆°n ho·∫∑c b·∫±ng 0!' }
                  ]}
                >
                  <InputNumber
                    placeholder="Nh·∫≠p s·ªë ti·ªÅn m·ª´ng"
                    style={{ width: '100%' }}
                    min={0}
                    formatter={value => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                    parser={value => value.replace(/\$\s?|(,*)/g, '')}
                  />
                </Form.Item>
              </Col>

              <Col xs={24} sm={8}>
                <Form.Item
                  label="Tr·∫°ng th√°i"
                  name="status"
                  rules={[{ required: true, message: 'Vui l√≤ng ch·ªçn tr·∫°ng th√°i!' }]}
                >
                  <Select placeholder="Ch·ªçn tr·∫°ng th√°i">
                    <Option value="Going">‚úÖ ƒêi</Option>
                    <Option value="NotGoing">‚ùå Kh√¥ng ƒëi</Option>
                    <Option value="Pending">‚è≥ Ch∆∞a x√°c nh·∫≠n</Option>
                  </Select>
                </Form.Item>
              </Col>
            </Row>

            <Row gutter={24}>
              <Col xs={24} sm={12}>
                <Form.Item
                  label="M·ªëi quan h·ªá"
                  name="relationship"
                  rules={[{ required: true, message: 'Vui l√≤ng ch·ªçn m·ªëi quan h·ªá!' }]}
                >
                  <Select placeholder="Ch·ªçn m·ªëi quan h·ªá">
                    <Option value="Family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Gia ƒë√¨nh</Option>
                    <Option value="Friend">üë´ B·∫°n b√®</Option>
                    <Option value="Colleague">üíº ƒê·ªìng nghi·ªáp</Option>
                    <Option value="Relative">üë• H·ªç h√†ng</Option>
                    <Option value="Other">ü§ù Kh√°c</Option>
                  </Select>
                </Form.Item>
              </Col>
            </Row>

            <Row gutter={24}>
              <Col xs={24}>
                <Form.Item
                  label="Ghi ch√∫"
                  name="notes"
                >
                  <TextArea
                    placeholder="Nh·∫≠p ghi ch√∫ (t√πy ch·ªçn)"
                    rows={4}
                    maxLength={500}
                    showCount
                  />
                </Form.Item>
              </Col>
            </Row>

            <Row>
              <Col xs={24}>
                <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                  <Link to="/wedding-guest-list">
                    <Button type="default">
                      H·ªßy
                    </Button>
                  </Link>
                  <Button
                    type="primary"
                    htmlType="submit"
                    loading={submitting}
                    icon={<Save size={16} />}
                    style={{ backgroundColor: '#ff69b4', borderColor: '#ff69b4' }}
                  >
                    Th√™m kh√°ch m·ªùi
                  </Button>
                </div>
              </Col>
            </Row>
          </Form>
        </Card>
      </div>
    </div>
  );
};

export default AddWeddingGuest;
